/*

Bogotá D.C, Colombia
Universidad Distrital Francisco José de Caldas, 
	
		
Proyecto #5 - Cajero Automático

INTEGRANTES:
Laura Ximena Flechas Ochoa
Paula Catalina Robayo Torres
Henry 'J.M.' Osorio Sánchez

*/

#include<iostream>
#include<ctime>
#include<string.h>
#include<stdio.h>

using namespace std;

void CrearFichero(FILE *Fichero);
void InsertarDatos(FILE *Fichero);
void VerDatos(FILE *Fichero);
void transaccion(FILE *Fichero);
void ingreso(FILE *Fichero); 

struct data {
   float saldo;
   
   int  pin;
};
struct tarjeta{
	double numero;
	struct data data_tarjeta;
	float trasferencia;
};

int main(int argc, char** argv)
{
	setlocale(LC_ALL, ""); // Esta línea permite que la máquina comprenda tíldes.
	system("color 0f");
	
	cout<<"\t ******************* \n";
	cout<<"\t      _  _  . _  _  _     _    _ _  _  _ _ . _  _      \n";
	cout<<"\t     |  || || ||| |   ||| | || |||||_| | ||  | |     \n";
	cout<<"\t     |_ | ||| |\\ ||   | ||| ||||||| | | || |_|    \n";
	cout<<"\t                                                         \n";
	cout<<"\t                                                         \n";
	cout<<"\t                                                         \n";
	cout<<"\t                             __                          \n";
	cout<<"\t                     |   |  |  \\                        \n";
	cout<<"\t                     |   |  |   \\                       \n";
	cout<<"\t                     |   |  |   |                        \n";
	cout<<"\t                     |   |  |   /                        \n";
	cout<<"\t                     |___|  |__/                         \n";
	cout<<"\t                                                         \n";
	cout<<"\t                                                         \n";
	cout<<"\t              Proyecto #5 - Cajero Automático            \n";
	cout<<"\t                                                         \n";
	cout<<"\t       INTEGRANTES:                                      \n";
	cout<<"\t       Laura Ximena Flechas Ochoa                        \n";
	cout<<"\t       Paula Catalina Robayo Torres                      \n";
	cout<<"\t       Henry 'J.M.' Osorio Sánchez                       \n";			
	cout<<"\t                                                         \n";
	cout<<"\t ******************* \n\n\n";
	
	cout<<"\t";
	system("pause");
	system("cls");
	
	
	cout<<"\n\t Bienvenido, este programa define un registro recopilatorio de n países por medio de la sentencia struct. \n\n";
    int i=0, opc=0, salida=0, acum=0;	
    
	FILE *fichero;
	
	while (!salida)
 	{	
 		cout<<"\n\n\t MENU: ";
    	cout<<"\n\t 1. Crear fichero: ";
    	cout<<"\n\t 2. Insertar tarjetas y pines: ";
    	cout<<"\n\t 3. Ver datos: ";
    	cout<<"\n\t 4. Transacción: ";
    	cout<<"\n\t 5. Salir: ";
    	cout<<"\n\t 6. ingreso: ";
    	
 		cout<<"\n\t Digite la opción: ";
 		cin>>opc;
 		cout<<"\n\n";
 
 		switch(opc)
 		{
 			case 1:
				CrearFichero(fichero);
 			break;
 			case 2:
				InsertarDatos(fichero);
 			break;
 			case 3:
				VerDatos(fichero);
 			break;
 			case 4:
				transaccion(fichero);
 			break;
 			case 5:
 				salida=1;
 			break;	
 			case 6:
 				ingreso(fichero);
 			default:
				cout<<"\n\t Opción no valida, reintente.";
					
				cout<<"\t ";
				system("pause");
				system("cls");
 		}
 	}
 
 	cout<<"\n\t Gracias por utilizar nuestro servicio. \n";
	cout<<"\t ";
	system("pause");
	cout<<"\n\n\n\n\n\n\n\n\n\n\n\n";
	return 0;
}

void CrearFichero(FILE *Fichero)
{
 	Fichero = fopen("fichero", "r");
 
 	if(!Fichero)
 	{
		Fichero = fopen("fichero", "w");
		cout<<"\n\t Archivo creado! \n\n";
		
		cout<<"\t ";
		system("pause");
		system("cls");
 	}
 	else
 	{
    	cout<<"\n\t El fichero ya existe! \n\n";
    	
		cout<<"\t ";
		system("pause");
		system("cls");
 	}
  	fclose (Fichero);
 
 	return;
}
 
void InsertarDatos(FILE *Fichero)
{
	Fichero = fopen("fichero", "a+");
 
	if(Fichero == NULL)
	{
		cout<<"\n\t Fichero no existe! \n\t Por favor créelo. \n\n";
		
		cout<<"\t ";
		system("pause");
		system("cls");
		
		return;
	}
	
		tarjeta tarjeta;
		
 			cout<<"\n\t Digite el número de tarjeta: ";
			cin>>tarjeta.numero;
 
			cout<<"\t Digite el número PIN: ";
			cin>>tarjeta.data_tarjeta.pin;
			while (tarjeta.data_tarjeta.pin<1000 || tarjeta.data_tarjeta.pin>10000){
				cout<<"\t Digite un PIN de 4 dígitos: \t";
				cin>>tarjeta.data_tarjeta.pin;
			}
			
			cout<<"\t Ingrese la cantidad de dinero (COP) que añadió en la inscripción de esta tarjeta: $";
			cin>>tarjeta.data_tarjeta.saldo;
			
			
			fwrite(&tarjeta, sizeof(struct tarjeta), 1, Fichero);
		
  	
	fclose(Fichero);
 
	return;
}
 
void VerDatos(FILE *Fichero)
{
	int numero=1;
	tarjeta tarjeta;
	
 	Fichero=fopen("fichero", "r");
 
	if(Fichero == NULL)
	{
		cout<<"\n\t Fichero no existe! \n\t Por favor creelo. \n\n";
		
		cout<<"\t ";
		system("pause");
		system("cls");
		return;
	}

	fread(&tarjeta, sizeof(struct tarjeta), 1, Fichero);
	cout<<"\n\t N.Tarjeta \tPIN \tSaldo \n";
 
	while(!feof(Fichero))
	{
		cout<<"\n\t "<<tarjeta.numero<<"\t"<<tarjeta.data_tarjeta.pin<<"\t "<<tarjeta.data_tarjeta.saldo;
		fread(&tarjeta, sizeof(struct tarjeta), 1, Fichero);
		
	}
 	fclose(Fichero);
 
	return;
}

void transaccion(FILE *Fichero){
	int numero=1;
	tarjeta tarjeta;
	
 	Fichero=fopen("fichero", "r+b");
 
	if(Fichero == NULL)
	{
		cout<<"\n\t Fichero no existe! \n\t Por favor creelo. \n\n";
		
		cout<<"\t ";
		system("pause");
		system("cls");
		return;
	}
	cout<<"ingrese la tarjeta a localizar: ";
    double cod;
    cin>>cod;
    cout<<"ingrese el pin: ";
    int p;
    cin>>p;
    
	fread(&tarjeta, sizeof(struct tarjeta), 1, Fichero);
 
	while(!feof(Fichero))
	{
		 if (cod==tarjeta.numero)
        {
        	if(p==tarjeta.data_tarjeta.pin){
        		cout<<"MENÚ"<<endl;
				cout<< "1. VER DATOS"<<endl;
				cout<< "2. HACER TRANSACCIÓN "<<endl;
				int opcion;
				cin>>opcion;
				switch(opcion){
					case 1:
						cout<<"Su cuenta tiene en este momento: $"<<tarjeta.data_tarjeta.saldo;
						
					break;
					case 2:
						float plata=0,plataT=0,eleccion=0;
						int aux=0;
						do{	
						    aux=aux+1;
							cout<<"De cuanto quiere hacer el retiro(máximo 100.000)";
							cin>>plata;
							while (plata>100000|| plata>tarjeta.data_tarjeta.saldo){
							cout<<"ingrese un valor valido";
							cin>>plata;
							}
							tarjeta.data_tarjeta.saldo=tarjeta.data_tarjeta.saldo-plata;
							int pos=ftell(Fichero)-sizeof(tarjeta);
          					fseek(Fichero,pos,SEEK_SET);
           					fwrite(&tarjeta, sizeof(tarjeta), 1, Fichero);
							cout<<"Retiro hecho con exito";
							cout<<"Quire hacer otro retiro";
							cout<<" 1.SI 2.No";
							cin>>eleccion;
							
						}while(eleccion==1 & aux!=3);
						cout<<fixed<<"su salado es de:"<<tarjeta.data_tarjeta.saldo<<endl;
						system("PAUSE");
						cout<<"/n Menu"<<endl;
						cout<<"1.Ver transacción";
						cout<<"2.Salir";
						cin>>opcion;
						switch(opcion){
							case 1:
							   int numero=1;
							  struct tarjeta tarjeta;
 								Fichero=fopen("fichero", "r");
								if(Fichero == NULL)
								{	
									cout<<"\n\t Fichero no existe! \n\t Por favor creelo. \n\n";
									cout<<"\t ";
									system("pause");
									system("cls");
									return;
								}

								fread(&tarjeta, sizeof(struct tarjeta), 1, Fichero);
 
								while(!feof(Fichero))
								{	
								cout<<tarjeta.trasferencia<<endl;
								fread(&tarjeta, sizeof(struct tarjeta), 1, Fichero);
								}
 								
 
								
							break;
							
						}
						
					break;
				}
		
			}else{
				cout<<"La clave es incorrecta";
			}
        
           
           system("PAUSE");
           break;
        }
		fread(&tarjeta, sizeof(struct tarjeta), 1, Fichero);
		
	}
 	fclose(Fichero);
 
	return;
}
void ingreso(FILE *Fichero){
	int numero=1;
	tarjeta tarjeta;
	
 	Fichero=fopen("fichero", "r+b");
 
	if(Fichero == NULL)
	{
		cout<<"\n\t Fichero no existe! \n\t Por favor creelo. \n\n";
		
		cout<<"\t ";
		system("pause");
		system("cls");
		return;
	}
	cout<<"ingrese la tarjeta a localizar: ";
    int cod;
    cin>>cod;
    cout<<"ingrese el pin: ";
    int p;
    cin>>p;
    
	fread(&tarjeta, sizeof(struct tarjeta), 1, Fichero);
 
	while(!feof(Fichero))
	{
		 if (cod==tarjeta.numero)
        {
        	if(p==tarjeta.data_tarjeta.pin){
        		cout<<"MENÚ"<<endl;
				cout<< "1. VER DATOS"<<endl;
				cout<< "2. INGRESAR MONTO "<<endl;
				int opcion;
				cin>>opcion;
				switch(opcion){
					case 1:
						cout<<"Su cuenta tiene en este momento: $"<<tarjeta.data_tarjeta.saldo;
						
					break;
					case 2:
						float plata=0,plataT=0,eleccion=0;
						int aux=0;
						do{	
						    aux=aux+1;
							cout<<"De cuanto quiere hacer el ingreso";
							cin>>plata;
							tarjeta.data_tarjeta.saldo=tarjeta.data_tarjeta.saldo+plata;
							int pos=ftell(Fichero)-sizeof(tarjeta);
          					fseek(Fichero,pos,SEEK_SET);
           					fwrite(&tarjeta, sizeof(tarjeta), 1, Fichero);
							cout<<"ingreso hecho con exito";
							cout<<"Quire hacer otro inreso?";
							cout<<" 1.SI 2.No";
							cin>>eleccion;
							
						}while(eleccion==1 & aux!=3);
						cout<<fixed<<"su salado es de:"<<tarjeta.data_tarjeta.saldo<<endl;
						system("PAUSE");
						cout<<"/n Menu"<<endl;
						cout<<"1.Ver transacción";
						cout<<"2.Salir";
						cin>>opcion;
						switch(opcion){
							case 1:
							   int numero=1;
							  struct tarjeta tarjeta;
 								Fichero=fopen("fichero", "r");
								if(Fichero == NULL)
								{	
									cout<<"\n\t Fichero no existe! \n\t Por favor creelo. \n\n";
									cout<<"\t ";
									system("pause");
									system("cls");
									return;
								}

								fread(&tarjeta, sizeof(struct tarjeta), 1, Fichero);
 
								while(!feof(Fichero))
								{	
								cout<<tarjeta.trasferencia<<endl;
								fread(&tarjeta, sizeof(struct tarjeta), 1, Fichero);
								}
 								
 
								
							break;
							
						}
						
					break;
				}
		
			}else{
				cout<<"La clave es incorrecta";
			}
        
           
           system("PAUSE");
           break;
        }
		fread(&tarjeta, sizeof(struct tarjeta), 1, Fichero);
		
	}
 	fclose(Fichero);
 
	return;
}
